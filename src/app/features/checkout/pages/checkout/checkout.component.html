<!-- ==========================================================================
     CHECKOUT COMPONENT TEMPLATE
     ========================================================================== -->

<div class="checkout-container">
  <!-- Header -->
  <div class="checkout-header">
    <div class="checkout-header-content">
      <h1 class="checkout-title">
        <i class="fas fa-shopping-bag"></i>
        Finalizar Compra
      </h1>
      <p class="checkout-subtitle">
        Complete os dados abaixo para finalizar seu pedido
      </p>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
    <p class="loading-text">Carregando dados do carrinho...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading" class="checkout-content">
    <div class="checkout-wrapper">
      
      <!-- Steps Navigation -->
      <div class="steps-navigation">
        <div class="steps-container">
          <div 
            class="step" 
            [class.active]="currentStep === 1"
            [class.completed]="currentStep > 1"
            (click)="goToStep(1)"
          >
            <div class="step-icon">
              <i class="fas fa-user" *ngIf="currentStep === 1"></i>
              <i class="fas fa-check" *ngIf="currentStep > 1"></i>
            </div>
            <span class="step-label">Dados Pessoais</span>
          </div>
          
          <div class="step-divider"></div>
          
          <div 
            class="step" 
            [class.active]="currentStep === 2"
            [class.completed]="currentStep > 2"
            [class.disabled]="!isStepAccessible(2)"
            (click)="goToStep(2)"
          >
            <div class="step-icon">
              <i class="fas fa-map-marker-alt" *ngIf="currentStep === 2"></i>
              <i class="fas fa-check" *ngIf="currentStep > 2"></i>
              <i class="fas fa-lock" *ngIf="currentStep < 2 && !isStepAccessible(2)"></i>
            </div>
            <span class="step-label">Endereço</span>
          </div>
          
          <div class="step-divider"></div>
          
          <div 
            class="step" 
            [class.active]="currentStep === 3"
            [class.disabled]="!isStepAccessible(3)"
            (click)="goToStep(3)"
          >
            <div class="step-icon">
              <i class="fas fa-credit-card" *ngIf="currentStep === 3"></i>
              <i class="fas fa-lock" *ngIf="currentStep < 3 && !isStepAccessible(3)"></i>
            </div>
            <span class="step-label">Pagamento</span>
          </div>
        </div>
      </div>

      <div class="checkout-main">
        <!-- Form Content -->
        <div class="form-section">
          <form [formGroup]="checkoutForm" class="checkout-form">
            
            <!-- Step 1: Dados Pessoais -->
            <div *ngIf="currentStep === 1" class="step-content">
              <div class="step-header">
                <h2>Dados Pessoais</h2>
                <p>Informe seus dados para identificação</p>
              </div>
              
              <div formGroupName="personalData" class="form-grid">
                <div class="form-group full-width">
                  <label for="fullName" class="form-label">Nome Completo *</label>
                  <input
                    id="fullName"
                    type="text"
                    formControlName="fullName"
                    class="form-input"
                    [class.error]="getFieldError('personalData.fullName')"
                    placeholder="Seu nome completo"
                  />
                  <div class="form-error" *ngIf="getFieldError('personalData.fullName')">
                    {{ getFieldError('personalData.fullName') }}
                  </div>
                </div>

                <div class="form-group">
                  <label for="email" class="form-label">E-mail *</label>
                  <input
                    id="email"
                    type="email"
                    formControlName="email"
                    class="form-input"
                    [class.error]="getFieldError('personalData.email')"
                    placeholder="seu@email.com"
                  />
                  <div class="form-error" *ngIf="getFieldError('personalData.email')">
                    {{ getFieldError('personalData.email') }}
                  </div>
                </div>

                <div class="form-group">
                  <label for="phone" class="form-label">Telefone *</label>
                  <input
                    id="phone"
                    type="tel"
                    formControlName="phone"
                    class="form-input"
                    [class.error]="getFieldError('personalData.phone')"
                    placeholder="(11) 99999-9999"
                    (input)="formatPhone($event)"
                  />
                  <div class="form-error" *ngIf="getFieldError('personalData.phone')">
                    {{ getFieldError('personalData.phone') }}
                  </div>
                </div>

                <div class="form-group">
                  <label for="cpf" class="form-label">CPF *</label>
                  <input
                    id="cpf"
                    type="text"
                    formControlName="cpf"
                    class="form-input"
                    [class.error]="getFieldError('personalData.cpf')"
                    placeholder="000.000.000-00"
                    (input)="formatCPF($event)"
                  />
                  <div class="form-error" *ngIf="getFieldError('personalData.cpf')">
                    {{ getFieldError('personalData.cpf') }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 2: Endereço de Entrega -->
            <div *ngIf="currentStep === 2" class="step-content">
              <div class="step-header">
                <h2>Endereço de Entrega</h2>
                <p>Onde você deseja receber seus livros?</p>
              </div>
              
              <div formGroupName="shippingAddress" class="form-grid">
                <div class="form-group">
                  <label for="cep" class="form-label">CEP *</label>
                  <input
                    id="cep"
                    type="text"
                    formControlName="cep"
                    class="form-input"
                    [class.error]="getFieldError('shippingAddress.cep')"
                    placeholder="00000-000"
                    (input)="formatCEP($event)"
                    (blur)="consultCEP()"
                  />
                  <div class="form-error" *ngIf="getFieldError('shippingAddress.cep')">
                    {{ getFieldError('shippingAddress.cep') }}
                  </div>
                </div>

                <div class="form-group triple-width">
                  <label for="street" class="form-label">Rua *</label>
                  <input
                    id="street"
                    type="text"
                    formControlName="street"
                    class="form-input"
                    [class.error]="getFieldError('shippingAddress.street')"
                    placeholder="Nome da rua"
                  />
                  <div class="form-error" *ngIf="getFieldError('shippingAddress.street')">
                    {{ getFieldError('shippingAddress.street') }}
                  </div>
                </div>

                <div class="form-group">
                  <label for="number" class="form-label">Número *</label>
                  <input
                    id="number"
                    type="text"
                    formControlName="number"
                    class="form-input"
                    [class.error]="getFieldError('shippingAddress.number')"
                    placeholder="123"
                  />
                  <div class="form-error" *ngIf="getFieldError('shippingAddress.number')">
                    {{ getFieldError('shippingAddress.number') }}
                  </div>
                </div>

                <div class="form-group double-width">
                  <label for="complement" class="form-label">Complemento</label>
                  <input
                    id="complement"
                    type="text"
                    formControlName="complement"
                    class="form-input"
                    placeholder="Apto, bloco, etc."
                  />
                </div>

                <div class="form-group">
                  <label for="neighborhood" class="form-label">Bairro *</label>
                  <input
                    id="neighborhood"
                    type="text"
                    formControlName="neighborhood"
                    class="form-input"
                    [class.error]="getFieldError('shippingAddress.neighborhood')"
                    placeholder="Nome do bairro"
                  />
                  <div class="form-error" *ngIf="getFieldError('shippingAddress.neighborhood')">
                    {{ getFieldError('shippingAddress.neighborhood') }}
                  </div>
                </div>

                <div class="form-group">
                  <label for="city" class="form-label">Cidade *</label>
                  <input
                    id="city"
                    type="text"
                    formControlName="city"
                    class="form-input"
                    [class.error]="getFieldError('shippingAddress.city')"
                    placeholder="Nome da cidade"
                  />
                  <div class="form-error" *ngIf="getFieldError('shippingAddress.city')">
                    {{ getFieldError('shippingAddress.city') }}
                  </div>
                </div>

                <div class="form-group">
                  <label for="state" class="form-label">Estado *</label>
                  <select
                    id="state"
                    formControlName="state"
                    class="form-input"
                    [class.error]="getFieldError('shippingAddress.state')"
                  >
                    <option value="">Selecione</option>
                    <option value="AC">Acre</option>
                    <option value="AL">Alagoas</option>
                    <option value="AP">Amapá</option>
                    <option value="AM">Amazonas</option>
                    <option value="BA">Bahia</option>
                    <option value="CE">Ceará</option>
                    <option value="DF">Distrito Federal</option>
                    <option value="ES">Espírito Santo</option>
                    <option value="GO">Goiás</option>
                    <option value="MA">Maranhão</option>
                    <option value="MT">Mato Grosso</option>
                    <option value="MS">Mato Grosso do Sul</option>
                    <option value="MG">Minas Gerais</option>
                    <option value="PA">Pará</option>
                    <option value="PB">Paraíba</option>
                    <option value="PR">Paraná</option>
                    <option value="PE">Pernambuco</option>
                    <option value="PI">Piauí</option>
                    <option value="RJ">Rio de Janeiro</option>
                    <option value="RN">Rio Grande do Norte</option>
                    <option value="RS">Rio Grande do Sul</option>
                    <option value="RO">Rondônia</option>
                    <option value="RR">Roraima</option>
                    <option value="SC">Santa Catarina</option>
                    <option value="SP">São Paulo</option>
                    <option value="SE">Sergipe</option>
                    <option value="TO">Tocantins</option>
                  </select>
                  <div class="form-error" *ngIf="getFieldError('shippingAddress.state')">
                    {{ getFieldError('shippingAddress.state') }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 3: Pagamento -->
            <div *ngIf="currentStep === 3" class="step-content">
              <div class="step-header">
                <h2>Forma de Pagamento</h2>
                <p>Como você deseja pagar?</p>
              </div>
              
              <div formGroupName="payment" class="form-grid">
                <div class="form-group full-width">
                  <label class="form-label">Método de Pagamento</label>
                  <div class="payment-methods">
                    <label class="payment-method">
                      <input type="radio" formControlName="method" value="credit_card" />
                      <span class="payment-method-content">
                        <i class="fas fa-credit-card"></i>
                        <span>Cartão de Crédito</span>
                      </span>
                    </label>
                    <label class="payment-method">
                      <input type="radio" formControlName="method" value="pix" />
                      <span class="payment-method-content">
                        <i class="fas fa-qrcode"></i>
                        <span>PIX</span>
                      </span>
                    </label>
                  </div>
                </div>

                <!-- Cartão de Crédito -->
                <div *ngIf="checkoutForm.get('payment.method')?.value === 'credit_card'" formGroupName="creditCard" class="credit-card-form">
                  <div class="form-group double-width">
                    <label for="cardNumber" class="form-label">Número do Cartão *</label>
                    <input
                      id="cardNumber"
                      type="text"
                      formControlName="number"
                      class="form-input"
                      [class.error]="getFieldError('payment.creditCard.number')"
                      placeholder="0000 0000 0000 0000"
                      (input)="formatCreditCard($event)"
                    />
                    <div class="form-error" *ngIf="getFieldError('payment.creditCard.number')">
                      {{ getFieldError('payment.creditCard.number') }}
                    </div>
                  </div>

                  <div class="form-group double-width">
                    <label for="cardName" class="form-label">Nome no Cartão *</label>
                    <input
                      id="cardName"
                      type="text"
                      formControlName="name"
                      class="form-input"
                      [class.error]="getFieldError('payment.creditCard.name')"
                      placeholder="Nome como está no cartão"
                    />
                    <div class="form-error" *ngIf="getFieldError('payment.creditCard.name')">
                      {{ getFieldError('payment.creditCard.name') }}
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="cardExpiry" class="form-label">Validade *</label>
                    <input
                      id="cardExpiry"
                      type="text"
                      formControlName="expiry"
                      class="form-input"
                      [class.error]="getFieldError('payment.creditCard.expiry')"
                      placeholder="MM/AA"
                      (input)="formatExpiry($event)"
                    />
                    <div class="form-error" *ngIf="getFieldError('payment.creditCard.expiry')">
                      {{ getFieldError('payment.creditCard.expiry') }}
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="cardCvv" class="form-label">CVV *</label>
                    <input
                      id="cardCvv"
                      type="text"
                      formControlName="cvv"
                      class="form-input"
                      [class.error]="getFieldError('payment.creditCard.cvv')"
                      placeholder="000"
                      maxlength="4"
                    />
                    <div class="form-error" *ngIf="getFieldError('payment.creditCard.cvv')">
                      {{ getFieldError('payment.creditCard.cvv') }}
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="installments" class="form-label">Parcelas *</label>
                    <select
                      id="installments"
                      formControlName="installments"
                      class="form-input"
                    >
                      <option value="1">1x de {{ formatPrice(cart.totalPrice) }} sem juros</option>
                      <option value="2">2x de {{ formatPrice(cart.totalPrice / 2) }} sem juros</option>
                      <option value="3">3x de {{ formatPrice(cart.totalPrice / 3) }} sem juros</option>
                      <option value="4">4x de {{ formatPrice(cart.totalPrice / 4) }} sem juros</option>
                      <option value="5">5x de {{ formatPrice(cart.totalPrice / 5) }} sem juros</option>
                      <option value="6">6x de {{ formatPrice(cart.totalPrice / 6) }} sem juros</option>
                    </select>
                  </div>
                </div>

                <!-- PIX -->
                <div *ngIf="checkoutForm.get('payment.method')?.value === 'pix'" class="pix-info">
                  <div class="pix-message">
                    <i class="fas fa-info-circle"></i>
                    <p>Após confirmar o pedido, você receberá um código PIX para pagamento instantâneo.</p>
                  </div>
                </div>
              </div>
            </div>
          </form>

          <!-- Navigation Buttons -->
          <div class="form-navigation">
            <button 
              *ngIf="currentStep > 1"
              type="button" 
              class="btn btn-secondary" 
              (click)="previousStep()"
            >
              <i class="fas fa-arrow-left"></i>
              Voltar
            </button>

            <button 
              *ngIf="currentStep < totalSteps"
              type="button" 
              class="btn btn-primary" 
              (click)="nextStep()"
              [disabled]="!isCurrentStepValid()"
            >
              Próximo
              <i class="fas fa-arrow-right"></i>
            </button>

            <button 
              *ngIf="currentStep === totalSteps"
              type="button" 
              class="btn btn-primary btn-large" 
              (click)="finishOrder()"
              [disabled]="!checkoutForm.valid || isProcessing"
            >
              <i class="fas fa-spinner fa-spin" *ngIf="isProcessing"></i>
              <i class="fas fa-credit-card" *ngIf="!isProcessing"></i>
              {{ isProcessing ? 'Processando...' : 'Finalizar Pedido' }}
            </button>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
          <div class="summary-card">
            <h3 class="summary-title">
              <i class="fas fa-receipt"></i>
              Resumo do Pedido
            </h3>

            <!-- Items -->
            <div class="summary-items">
              <div 
                *ngFor="let item of cart.items; trackBy: trackByBookId" 
                class="summary-item"
              >
                <div class="item-info">
                  <div class="item-image">
                    <img 
                      [src]="item.book.imageUrl || '/assets/images/book-placeholder.jpg'" 
                      [alt]="item.book.name"
                      (error)="onImageError($event)"
                    />
                  </div>
                  <div class="item-details">
                    <h4 class="item-title">{{ item.book.name }}</h4>
                    <p class="item-author">{{ item.book.author || 'Autor não informado' }}</p>
                    <p class="item-genre">{{ getGenderName(item.book.genderID) }}</p>
                    <div class="item-quantity">
                      Qtd: {{ item.quantity }}
                    </div>
                  </div>
                </div>
                <div class="item-price">
                  {{ formatPrice(item.subtotal) }}
                </div>
              </div>
            </div>

            <!-- Totals -->
            <div class="summary-totals">
              <div class="summary-line">
                <span class="summary-label">Subtotal ({{ cart.totalItems }} {{ cart.totalItems === 1 ? 'item' : 'itens' }}):</span>
                <span class="summary-value">{{ formatPrice(cart.totalPrice) }}</span>
              </div>
              <div class="summary-line">
                <span class="summary-label">Frete:</span>
                <span class="summary-value summary-free">Grátis</span>
              </div>
              <div class="summary-line summary-total">
                <span class="summary-label">Total:</span>
                <span class="summary-value">{{ formatPrice(cart.totalPrice) }}</span>
              </div>
            </div>

            <!-- Actions -->
            <div class="summary-actions">
              <button 
                type="button" 
                class="btn btn-outline btn-small" 
                (click)="goToCart()"
              >
                <i class="fas fa-edit"></i>
                Editar Carrinho
              </button>
              
              <button 
                type="button" 
                class="btn btn-secondary btn-small" 
                (click)="continueShopping()"
              >
                <i class="fas fa-arrow-left"></i>
                Continuar Comprando
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Overlay -->
  <div *ngIf="isProcessing" class="processing-overlay">
    <div class="processing-content">
      <div class="processing-spinner">
        <i class="fas fa-spinner fa-spin"></i>
      </div>
      <h3>Processando seu pedido...</h3>
      <p>Aguarde enquanto finalizamos sua compra</p>
    </div>
  </div>
</div>
